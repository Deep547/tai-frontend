@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.tai.auth.ConfigProperties
@import uk.gov.hmrc.urls.Link
@import uk.gov.hmrc.play.views.helpers.MoneyPounds
@import uk.gov.hmrc.play.views.formatting.Money._
@import uk.gov.hmrc.play.views.html.layouts.loginStatus
@import uk.gov.hmrc.tai.model.RtiCalc
@import uk.gov.hmrc.tai.util.TaxSummaryHelper
@import uk.gov.hmrc.tai.config.ApplicationConfig
@import uk.gov.hmrc.tai.model.rti.RtiPayment
@import uk.gov.hmrc.play.views.html.helpers._
@import uk.gov.hmrc.play.views.helpers._
@import uk.gov.hmrc.tai.model.CeasedEmploymentDetails
@import uk.gov.hmrc.tai.util.CeasedEmploymentHelper
@import uk.gov.hmrc.tai.util.TaiConstants._
@import uk.gov.hmrc.play.language.LanguageUtils.Dates
@import uk.gov.hmrc.time.TaxYearResolver

@(incomeCalcDetails: uk.gov.hmrc.tai.viewModels.YourIncomeCalculationViewModel, empId: Int)(implicit request: Request[_],
messages: Messages, user: controllers.auth.TaiUser)

@printWrapper(title = Messages("tai.yourIncome.heading"), header = Messages("tai.yourIncome.heading")){
    <a id="backLink" href="@controllers.routes.YourIncomeCalculationController.yourIncomeCalculationPage(Some(empId))">@Messages("tai.label.back")</a>
}{

    <br><strong><p>@user.getDisplayName</p></strong>
    <section class="section soft--top"><h2>@Messages("tai.income.calculation.TaxableIncomeDetails", incomeCalcDetails.employerName)</h2></section>
	    <section class="section soft--top">
            @incomeCalcDetails.employmentStatus match {
                case Some(EmploymentPotentiallyCeased) => {
                    @if(incomeCalcDetails.employmentPayments.nonEmpty) {
                    <strong>@Messages("tai.income.calculation.ceased.heading",Dates.formatDate(incomeCalcDetails.employmentPayments.last.paidOn))</strong>
                    } else {
                    <strong>@Messages("tai.income.calculation.heading",s"${Dates.formatDate(TaxYearResolver.startOfCurrentTaxYear)}",s"${Dates.formatDate(TaxYearResolver.endOfCurrentTaxYear)}")</strong>
                    }

                    <p>@Messages("tai.income.calculation.potentially.ceased.lede")</p>
                }
                case Some(EmploymentCeased) => {
                    @if(incomeCalcDetails.employmentPayments.nonEmpty) {
                    <strong>@Messages("tai.income.calculation.ceased.heading",Dates.formatDate(incomeCalcDetails.employmentPayments.last.paidOn))</strong>
                    } else {
                    <strong>@Messages("tai.income.calculation.heading",s"${Dates.formatDate(TaxYearResolver.startOfCurrentTaxYear)}",s"${Dates.formatDate(TaxYearResolver.endOfCurrentTaxYear)}")</strong>
                    }

                    <p>@Messages("tai.income.calculation.rti.ceased.emp",s"${CeasedEmploymentHelper.toDisplayFormat(incomeCalcDetails.endDate)}")</p>
                }

                case _ => {
                    @if(incomeCalcDetails.employmentPayments.nonEmpty) {
                        <strong>@Messages("tai.income.calculation.heading.withRti", Dates.formatDate(incomeCalcDetails.employmentPayments.last.paidOn))</strong>
                    } else {
                        <strong>@Messages("tai.income.calculation.heading",s"${Dates.formatDate(TaxYearResolver.startOfCurrentTaxYear)}",s"${Dates.formatDate(TaxYearResolver.endOfCurrentTaxYear)}")</strong>
                    }
                    @if(!incomeCalcDetails.rtiDown) {
                        <p id="incomeCalculationMsg@incomeCalcDetails.empId">@incomeCalcDetails.incomeCalculationMsg</p>
                        @incomeCalcDetails.payrollMsg.map { payrollMessage =>
                            <p id="payrollNumber@incomeCalcDetails.empId">@payrollMessage</p>
                        }
                    } else {
                        <p id="rtiUnavailableCurrentYear">@Messages("tai.income.calculation.rtiUnavailableCurrentYear.message")</p>
                        <p id="rtiUnavailableCurrentYearContact">@Messages("tai.income.calculation.rtiUnavailableCurrentYear.message.contact")</p>

                    }
                }
            }
	    </section>

    @if(incomeCalcDetails.employmentPayments.nonEmpty) {
        <section class="section soft--top soft--bottom">
            <table id="taxable-income-table" class="print-table-section print-table">
                <thead>
                <tr class="print-table__row--bold">
                    <th id="print-date-column">@Messages("tai.income.calculation.incomeTable.dateHeader")</th>
                    <th id="print-taxable-income-column" class="print-text--right">@Messages("tai.income.calculation.incomeTable.print.incomeHeader")</th>
                    <th id="print-income-tax-paid-column" class="print-text--right">@Messages("tai.income.calculation.incomeTable.print.taxPaidHeader")</th>
                    <th id="print-ni-paid-column" class="print-text--right">@Messages("tai.income.calculation.incomeTable.print.nationalInsuranceHeader")</th>
                </tr>
                </thead>
                <tbody>
                @for(payment <- incomeCalcDetails.employmentPayments){
                <tr class="print-pension-contributions-data">
                    <td>@Dates.formatDate(payment.paidOn)</td>
                    <td class="print-text--right">£ @{f"${payment.taxablePay}%,.2f"}</td>
                    <td class="print-text--right">£ @{f"${payment.taxed}%,.2f"}</td>
                    @if(payment.nicPaid.isDefined){
                    <td class="print-text--right">£ @{f"${payment.nicPaid.get}%,.2f"}</td>
                    }else {
                    <td class="print-text--right"></td>
                    }
                </tr>
                }
                </tbody>
                <tfoot>
                <tr class="print-table__row--bold">
                    <td>@Messages("tai.taxFree.total")</td>
                    <td class="print-text--right">£ @{f"${incomeCalcDetails.employmentPayments.last.taxablePayYTD}%,.2f"}</td>
                    <td class="print-text--right">£ @{f"${incomeCalcDetails.employmentPayments.last.taxedYTD}%,.2f"}</td>
                    @if(incomeCalcDetails.employmentPayments.last.nicPaid.isDefined){
                    <td class="print-text--right">£ @{f"${incomeCalcDetails.employmentPayments.last.nicPaidYTD.get}%,.2f"}</td>
                    }else {
                    <td class="print-text--right"></td>
                    }
                </tr>
                </tfoot>
            </table>

            @incomeCalcDetails.totalNotEqualMessage.map{ message =>
            <p>@message</p>
            <p>@Messages("tai.income.calculation.totalNotMatching.message")</p>
            }
        </section>
    }

    <div class="grid-row">
        <div class="grid grid-2-3">
            <div class="inner-block">
                @incomeCalcDetails.employmentStatus match {
                    case Some(EmploymentPotentiallyCeased) => {
                        @if(incomeCalcDetails.employmentPayments.nonEmpty) {
                            <h4 class="heading-small">@Messages("tai.income.calculation.potentailly.ceased", {f"${incomeCalcDetails.employmentPayments.last.taxablePayYTD}%,.2f"})</h4>
                        }
                    }

                    case _ => {
                        <h4 class="heading-small">@incomeCalcDetails.incomeCalculationEstimateMsg</h4>

                        @if(incomeCalcDetails.editableDetails.isEditable && incomeCalcDetails.editableDetails.payRollingBiks){
                            <div class="panel-indent panel-indent--info panel-indent--gutter">
                                <p id="payrolling1">@Messages("tai.income.calculation.payrollingBik.message1")</p>
                                <p id="payrolling2">@Messages("tai.income.calculation.payrollingBik.message2")</p>
                            </div>
                        }
                    }
                }
            </div>
        </div>
    </div>

}

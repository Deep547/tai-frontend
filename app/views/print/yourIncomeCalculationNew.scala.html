@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.tai.util.CeasedEmploymentHelper
@import uk.gov.hmrc.tai.util.TaiConstants._
@import uk.gov.hmrc.urls.Link
@import uk.gov.hmrc.tai.viewModels.YourIncomeCalculationViewModelNew
@import uk.gov.hmrc.time.TaxYearResolver
@import uk.gov.hmrc.tai.model.domain.income._
@import uk.gov.hmrc.tai.model.domain._

@(model: YourIncomeCalculationViewModelNew)(implicit request: Request[_],
messages: Messages, user: controllers.auth.TaiUser)

@printWrapper(title = Messages("tai.yourIncome.heading"), header = Messages("tai.yourIncome.heading")){
    <a id="backLink" href="@controllers.routes.YourIncomeCalculationControllerNew.yourIncomeCalculationPage(model.empId)">@Messages("tai.label.back")</a>
}{

    <br><strong><p>@user.getDisplayName</p></strong>
    <section class="section soft--top"><h2>@Messages("tai.income.calculation.TaxableIncomeDetails", model.employerName)</h2></section>
	    <section class="section soft--top">
            @model.employmentStatus match {
                case PotentiallyCeased => {
                    @if(model.latestPayment.isDefined) {
                        <strong>@Messages("tai.income.calculation.heading.withRti", model.latestPayment.get.date.toString("d MMMM yyyy"))</strong>
                    } else {
                        <strong>@Messages("tai.income.calculation.heading",s"${TaxYearResolver.startOfCurrentTaxYear.toString("d MMMM yyyy")}",s"${TaxYearResolver.endOfCurrentTaxYear.toString("d MMMM yyyy")}")</strong>
                    }

                    <p>@Messages("tai.income.calculation.potentially.ceased.lede")</p>
                }

                case Ceased => {
                    @if(model.latestPayment.isDefined) {
                        <strong>@Messages("tai.income.calculation.ceased.heading", model.latestPayment.get.date.toString("d MMMM yyyy"))</strong>
                    } else {
                        <strong>@Messages("tai.income.calculation.heading",s"${TaxYearResolver.startOfCurrentTaxYear.toString("d MMMM yyyy")}",s"${TaxYearResolver.endOfCurrentTaxYear.toString("d MMMM yyyy")}")</strong>
                    }

                    <p>@Messages("tai.income.calculation.rti.ceased.emp",s"${CeasedEmploymentHelper.toDisplayFormat(model.endDate)}")</p>
                }

                case _ => {
                    @if(model.latestPayment.isDefined) {
                       <strong>@Messages("tai.income.calculation.heading.withRti", model.latestPayment.get.date.toString("d MMMM yyyy"))</strong>
                    } else {
                        <strong>@Messages("tai.income.calculation.heading",s"${TaxYearResolver.startOfCurrentTaxYear.toString("d MMMM yyyy")}",s"${TaxYearResolver.endOfCurrentTaxYear.toString("d MMMM yyyy")}")</strong>
                    }

                    @if(model.rtiStatus == TemporarilyUnavailable) {
                        <p id="rtiUnavailableCurrentYear">@Messages("tai.income.calculation.rtiUnavailableCurrentYear.message")</p>
                        <p id="rtiUnavailableCurrentYearContact">@Messages("tai.income.calculation.rtiUnavailableCurrentYear.message.contact")</p>
                    } else {

                    }
                }
            }
	    </section>

    @if(model.latestPayment.isDefined) {
        <section class="section soft--top soft--bottom">
            <table id="taxable-income-table" class="print-table-section print-table">
                <thead>
                <tr class="print-table__row--bold">
                    <th id="print-date-column">@Messages("tai.income.calculation.incomeTable.dateHeader")</th>
                    <th id="print-taxable-income-column" class="print-text--right">@Messages("tai.income.calculation.incomeTable.print.incomeHeader")</th>
                    <th id="print-income-tax-paid-column" class="print-text--right">@Messages("tai.income.calculation.incomeTable.print.taxPaidHeader")</th>
                    <th id="print-ni-paid-column" class="print-text--right">@Messages("tai.income.calculation.incomeTable.print.nationalInsuranceHeader")</th>
                </tr>
                </thead>
                <tbody>
                @for(payment <- model.payments){
                <tr class="print-pension-contributions-data">
                    <td>@payment.date.toString("d MMM yyyy")</td>
                    <td class="print-text--right">£ @{f"${payment.taxableIncome}%,.2f"}</td>
                    <td class="print-text--right">£ @{f"${payment.taxAmount}%,.2f"}</td>
                    <td class="print-text--right">£ @{f"${payment.nationalInsuranceAmount}%,.2f"}</td>
                </tr>
                }
                </tbody>
                <tfoot>
                <tr class="print-table__row--bold">
                    <td>@Messages("tai.taxFree.total")</td>
                    <td class="print-text--right">£ @{f"${model.latestPayment.get.amountYearToDate}%,.2f"}</td>
                    <td class="print-text--right">£ @{f"${model.latestPayment.get.taxAmountYearToDate}%,.2f"}</td>
                    <td class="print-text--right">£ @{f"${model.latestPayment.get.nationalInsuranceAmountYearToDate}%,.2f"}</td>
                </tr>
                </tfoot>
            </table>

            @if(model.messageWhenTotalNotEqual.isDefined) {
                <p>@model.messageWhenTotalNotEqual.get</p>
                <p>@Messages("tai.income.calculation.totalNotMatching.message")</p>
            }
        </section>
    }

    <div class="grid-row">
        <div class="grid grid-2-3">
            <div class="inner-block">
                @model.employmentStatus match {
                    case PotentiallyCeased => {
                        @if(model.latestPayment.isDefined) {
                            <h4 class="heading-small">@Messages("tai.income.calculation.potentailly.ceased", {f"${model.latestPayment.get.amountYearToDate}%,.2f"})</h4>
                        }
                    }

                    case _ => {

                    }
                }
            </div>
        </div>
    </div>

}

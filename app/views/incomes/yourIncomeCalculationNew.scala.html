@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.tai.util.CeasedEmploymentHelper
@import uk.gov.hmrc.tai.util.TaiConstants._
@import uk.gov.hmrc.urls.Link
@import uk.gov.hmrc.tai.viewModels.YourIncomeCalculationViewModelNew
@import uk.gov.hmrc.time.TaxYearResolver
@import uk.gov.hmrc.tai.model.domain.income._
@import uk.gov.hmrc.tai.model.domain._

@(model: YourIncomeCalculationViewModelNew)(implicit request: Request[_], user: controllers.auth.TaiUser, messages: Messages, templateRenderer: uk.gov.hmrc.renderer.TemplateRenderer, partialRetriever: uk.gov.hmrc.play.partials.PartialRetriever)

@main(
    title = Messages("tai.yourIncome.heading"),
    user = Some(user),
    employerName = Some(model.employerName),
    gaCustomTitle = None
){

@defining("d MMMM yyyy") { dateFormatPattern =>

    <div style="float: right;">
        @Link.toInternalPage(url=routes.YourIncomeCalculationController.printYourIncomeCalculationPage(Some(model.empId)).toString,value=Some(Messages("tai.label.print"))).toHtml
    </div>
    <header class="page-header">
        <h1 class="heading-xlarge flush--bottom" id="currentYearTitle">@Messages("tai.income.calculation.TaxableIncomeDetails", model.employerName)</h1>
    </header>

    <div class="grid-row">
        <div class="grid grid-2-3">
            <div class="inner-block">
                <div class="subsection">
                    @model.employmentStatus match {
                        case PotentiallyCeased => {
                            @if(model.latestPayment.isDefined) {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading.withRti", model.latestPayment.get.date.toString(dateFormatPattern))</h2>
                            } else {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading",s"${TaxYearResolver.startOfCurrentTaxYear.toString(dateFormatPattern)}",s"${TaxYearResolver.endOfCurrentTaxYear.toString(dateFormatPattern)}")</h2>
                            }

                            <p class="text">@Messages("tai.income.calculation.potentially.ceased.lede")</p>
                        }

                        case Ceased => {
                            @if(model.latestPayment.isDefined) {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.ceased.heading", model.latestPayment.get.date.toString(dateFormatPattern))</h2>
                            } else {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading",s"${TaxYearResolver.startOfCurrentTaxYear.toString(dateFormatPattern)}",s"${TaxYearResolver.endOfCurrentTaxYear.toString(dateFormatPattern)}")</h2>
                            }

                            <p class="text">@Messages("tai.income.calculation.rti.ceased.emp",s"${CeasedEmploymentHelper.toDisplayFormat(model.endDate)}")</p>
                        }

                        case _ => {
                            @if(model.latestPayment.isDefined) {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading.withRti", model.latestPayment.get.date.toString(dateFormatPattern))</h2>
                            } else {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading",s"${TaxYearResolver.startOfCurrentTaxYear.toString(dateFormatPattern)}",s"${TaxYearResolver.endOfCurrentTaxYear.toString(dateFormatPattern)}")</h2>
                            }

                            @if(model.rtiStatus == TemporarilyUnavailable) {
                                <p id="rtiUnavailableCurrentYear">@Messages("tai.income.calculation.rtiUnavailableCurrentYear.message")</p>
                                <p id="rtiUnavailableCurrentYearContact">@Messages("tai.income.calculation.rtiUnavailableCurrentYear.message.contact")</p>
                            } else {

                            }
                        }
                    }
                </div>

                @if(model.latestPayment.isDefined) {
                    <div class="section soft--top soft--bottom">
                        <table id="taxable-income-table" class="table-section">
                            <thead>
                                <tr>
                                    <th>@Messages("tai.income.calculation.incomeTable.dateHeader")</th>
                                    <th class="text--right">@Messages("tai.income.calculation.incomeTable.incomeHeader")</th>
                                    <th class="text--right">@Messages("tai.income.calculation.incomeTable.taxPaidHeader")</th>
                                    <th class="text--right">@Messages("tai.income.calculation.incomeTable.nationalInsuranceHeader")</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr class="table__row--bold">
                                    <td>@Messages("tai.taxFree.total")</td>
                                    <td class="text--right">@{f"${model.latestPayment.get.amountYearToDate}%,.2f"}</td>
                                    <td class="text--right">@{f"${model.latestPayment.get.taxAmountYearToDate}%,.2f"}</td>
                                    <td class="text--right">@{f"${model.latestPayment.get.nationalInsuranceAmountYearToDate}%,.2f"}</td>
                                </tr>
                            </tfoot>
                            <tbody>
                                @for(payment <- model.payments){
                                    <tr class="pension-contributions-data">
                                        <td>@payment.date.toString(dateFormatPattern)</td>
                                        <td class="text--right">@{f"${payment.taxableIncome}%,.2f"}</td>
                                        <td class="text--right">@{f"${payment.taxAmount}%,.2f"}</td>
                                        <td class="text--right">@{f"${payment.nationalInsuranceAmount}%,.2f"}</td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        @model.messageWhenTotalNotEqual.map { message =>
                            <p>@message</p>
                            <p>@Messages("tai.income.calculation.totalNotMatching.message")</p>
                        }
                    </div>
                }


                @model.employmentStatus match {
                    case PotentiallyCeased => {

                    }

                    case Ceased => {

                    }

                    case _ => {
                        @if(model.isPension){
                            <p id="pensionUpdateLink" class="text">@Html(Messages(
                                "tai.income.calculation.update.pension",
                                Link.toInternalPage(url=routes.IncomeUpdateCalculatorController.chooseHowToUpdatePage.toString, value=Some(Messages("tai.income.calculation.updateLink.regular"))).toHtml
                                ))
                            </p>
                            <p id="pensionIFormLink" class="text">@Html(Messages(
                                "tai.yourTaxableIncome.otherDetailsWrongPensionIform",
                                Link.toInternalPage(url=routes.AuditController.auditLinksToIForm(EmployeePensionIForm).url, value=Some(Messages("tai.yourTaxableIncome.otherDetailsWrongIformLink"))).toHtml
                                ))
                            </p>
                        } else {
                            <p id="regularUpdateLink" class="text">@Html(Messages(
                                "tai.income.calculation.update.regular",
                                Link.toInternalPage(url=routes.IncomeUpdateCalculatorController.chooseHowToUpdatePage.toString, value=Some(Messages("tai.income.calculation.updateLink.regular"))).toHtml
                                ))
                            </p>
                        }
                    }

                }

                <div class="subsection">
                    @Link.toInternalPage(
                        id=Some("returnToSummary"),
                        value=Some(Messages("tai.IncomeTaxSummaryReturn")),
                        url = routes.TaxAccountSummaryController.onPageLoad.url,
                        cssClasses=Some("button")
                    ).toHtml
                </div>

            </div>
        </div>
    </div>
}
}